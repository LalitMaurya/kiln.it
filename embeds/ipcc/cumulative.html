<!DOCTYPE html>
<html>
<head>
  <title>How do we know that it's cumulative emissions that count?</title>
  <meta http-equiv="Content-type" content="text/html; charset=utf-8">

  <script src="js/d3.v3.js" charset="utf-8"></script>
  <script src="js/jquery.min.js"></script>
  <script src="js/bootstrap.min.js"></script>
  <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="https://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
    
  <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap.min.css">
  <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap-theme.min.css">
  <link rel="stylesheet" href="css/font-awesome.css" rel="stylesheet">
  <link rel="stylesheet" href="css/fonts.css" type="text/css" />
  <link rel="stylesheet" href="css/comparisons.css" type="text/css" />

  <style type="text/css">
  body { min-width: 450px; }
  #wrapper { width: 100%; padding: 20px 5%; }
  #graph { margin: 0; }
  .axis path, .axis line { fill: none; stroke: #000; shape-rendering: crispEdges; }
  .y.axis path { display: none; }
  .y.axis line { fill: none; stroke: #666; stroke-dasharray: 2,2; }
  .x.axis .tick { stroke: #777; stroke-dasharray: none; }
  .x.axis .minor { stroke-opacity: 0.4; }
  #info { margin: 20px 40px; display: block; font-size: 14px; }
  #zoom { font-size: 20px; padding: 0 40px; line-height: 20px; position: absolute; left: 0; bottom: 20px;  }
  #left-zoom, #right-zoom { cursor: pointer; }
  .icons { font-family: FontAwesome; fill: #888; text-anchor: middle; cursor: pointer; }
  .button-mini { font-size: 11px; color: yellow; }
  #choosers { text-align: center; }
  .chooser { display: inline-block; margin: 10px; }
  .chooser-label { margin-bottom: 4px; }
  #scenario-label { display: inline-block; vertical-align: middle; line-height: 1.2; font-size: 16px; text-align: right; padding-right: 10px; }  
  #lineLow, #lineHigh { fill: none; stroke: #999; stroke-width: 2; }
  .highlighted-line { stroke: black!important; stroke-width: 5!important;  }
  #line-label { font-size: 20px; }
  .overlay {
    fill: none;
    pointer-events: all;
  }
  .focus circle {
    fill: none;
    stroke: steelblue;
  }
  @media only screen and (max-width : 500px) {
    #line-label { font-size: 14px; }
  }
  .emissions-line { fill: none; stroke-width: 1.5; }
  #linercp3PD { stroke: green; }
  #linercp45 { stroke: orange; }
  #linercp60 { stroke: red; }
  #linercp85 { stroke: purple; }
  </style>

</head>
<body>
  <div id="wrapper">
    <div id="choosers">
      <div id="report" class="chooser">
        <span class="btn-group" data-toggle="buttons">
          <label class="emissions btn btn-primary btn-lg active"><input type="radio" name="options" id="report-option1"> Emissions so far</label>
          <label class="scenarios btn btn-primary btn-lg"><input type="radio" name="options" id="report-option2"> Emissions over time</label>
          <label class="temps btn btn-primary btn-lg"><input type="radio" name="options" id="report-option3"> Cumulative emissions  </label>
        </span>
      </div>
    </div>
    <div id="graph">
      <!--[if lte IE 8]>
      <div id="ie8message">This interactive is not supported by your browser. To see it, download a modern browser such as <a href="https://www.google.com/chrome">Chrome</a>, <a href="http://www.getfirefox.net">Firefox</a>, <a href="http://www.apple.com/safari/">Safari</a> or Internet Explorer 9.</div>
      <![endif]-->
    </div>
    <div id="info"></div>
  </div>
</body>

<script>
$('.nav-tabs').button();

var range, tcr, ecs, margin, width, height, x, y, xAxis, yAxis;

// Defaults
var locked = false,
    scenarioName = "RCP 8.5",
    initialMin = 1860,
    initialMax = 2012,
    untouched = true,
    view = "emissions";
    
function defineLayout() {
  margin = {top: 40, right: 70, bottom: 30, left: 50};
  width = parseFloat(d3.select("#graph").style("width")) - margin.left - margin.right;
  height = 400 - margin.top - margin.bottom;

  x = d3.scale.linear().range([0, width]);
  y = d3.scale.linear().range([height, 0]);
  xAxis = d3.svg.axis().scale(x).tickSubdivide(true).tickFormat(d3.format());
  yAxis = d3.svg.axis().scale(y).tickSize(-width).orient("right");
  
}
defineLayout();

function drawGraph() {
  // Load data and draw graph
  d3.csv("data-complete.csv", parse, function(error, data) {

    // Create SVG
    d3.select("body #graph").append("svg")
        .attr("width", "100%")
        .attr("height", height + margin.top + margin.bottom);

    // Add gradient shading definitions
    var grad = d3.select("svg").append("defs")
      .append("linearGradient").attr("id","shading").attr("x1","0%").attr("y1","0%").attr("x2","0%").attr("y2","100%");
    grad.append("stop").attr("offset","0%").attr("style","stop-color: purple; stop-opacity: 1");
    grad.append("stop").attr("offset","50%").attr("style","stop-color: purple; stop-opacity: 0.8");
    grad.append("stop").attr("offset","60%").attr("style","stop-color: red; stop-opacity: 0.8");
    grad.append("stop").attr("offset","90%").attr("style","stop-color: rgb(20,200,20); stop-opacity: 0.8");
    grad.append("stop").attr("offset","100%").attr("style","stop-color: rgb(40,200,40); stop-opacity: 1");

    // Set bounds to display
    var dataStartYear = 1765,
        lowerBounds = initialMin - dataStartYear + 6,
        upperBounds = initialMax - dataStartYear + 6;
    y.domain([0, data[upperBounds].cumulativercp85]);
    x.domain([data[lowerBounds].year, data[upperBounds].year]);

    // Create graph
    var svg = d3.select("svg")
        .append("g")
          .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

    // Add the clip path
    svg.append("clipPath")
        .attr("id", "clip")
      .append("rect")
        .attr("width", width)
        .attr("height", height);

    // Add the x-axis
    svg.append("g")
      .attr("class", "x axis")
      .attr("transform", "translate(0," + height + ")")
      .call(xAxis);

    // Add x-axis zoom icons
    var zooms = d3.select("svg").append("g")
        .attr("id","zoom");

    zooms.append("text")
        .classed("icons",true)
        .attr("id","lock-left-minus")
        .attr("x",margin.left * 0.3)
        .attr("y",height + margin.top + 2)
        .text("\uF010");

    zooms.append("text")
        .classed("icons",true)
        .attr("id","lock-left-plus")
        .attr("x",margin.left * 0.3)
        .attr("y",height + margin.top + 22)
        .text("\uF00E");

    zooms.append("text")
        .classed("icons",true)
        .attr("id","lock-right-minus")
        .attr("x", width + margin.left + margin.right - 10)
        .attr("y",height + margin.top + 2)
        .text("\uF010");

    zooms.append("text")
       .classed("icons",true)
       .attr("id","lock-right-plus")
       .attr("x", width + margin.left + margin.right - 10)
       .attr("y", height + margin.top + 22)
       .text("\uF00E");

    // Add the y-axis
    svg.append("g")
      .attr("class", "y axis")
      .classed("next",true)
      .attr("transform", "translate(" + width + ",0)")
      .call(yAxis);

    svg.append("text")
        .attr("class", "y label")
        .attr("text-anchor", "middle")
        .attr("y", width + 50)
        .attr("x", -height/2)
        .attr("dy", ".75em")
        .attr("transform", "rotate(-90)")
        .text("Temperature change (°C)");

    // Add the y-axis lock icon
    var lock = d3.select("svg").append("g")
        .attr("id","lock")
        .classed("icons",true)

    lock.append("circle")
        .attr("cx",width + margin.left + 12)
        .attr("cy",15)
        .attr("r",12)
        .style("fill","#999");

    lock.append("text")
        .attr("id","lock-icon")
        .attr("x",width + margin.left + 12)
        .attr("y",20)
        .text("\uF09C")
        .style("fill","white");

    // Trial -- add mouseover feature 
    var bisectDate = d3.bisector(function(d) { return d.year; }).left;

    var mousemove = function() {
       var x0 = x.invert(d3.mouse(this)[0]),
           i = bisectDate(data, x0, 1),
           d0 = data[i - 1],
           d1 = data[i],
           d = x0 - d0.date > d1.date - x0 ? d1 : d0;
       focus.attr("transform", "translate(" + x(d.year) + "," + y(d.cumulativercp3PD) + ")");
       focus.select("text").text(d.year);
     }

    var focus = svg.append("g")
          .attr("class", "focus")
          .style("display", "none");

    focus.append("circle")
        .attr("r", 4.5);

    focus.append("text")
        .attr("x", 9)
        .attr("dy", ".35em");

    svg.append("rect")
         .attr("class", "overlay")
         .attr("width", width)
         .attr("height", height)
         .on("mouseover", function() { focus.style("display", null); })
         .on("mouseout", function() { focus.style("display", "none"); })
         .on("mousemove", mousemove);
    


    // Line generators
    
    var observed = d3.svg.line().interpolate("monotone")
      .x(function(d) { return x(d.year); })
      .y(function(d) { return y(d.observations); })
      .defined(function(d) { return !isNaN(d.observations) && !(d.observations > 100) });
    
    var linercp3PD = d3.svg.line().interpolate("monotone")
      .x(function(d) { return x(d.year); })
      .y(function(d) { return y(d["cumulativercp3PD"]); })
      .defined(function(d) { return !isNaN(d.year) });
    var linercp45 = d3.svg.line().interpolate("monotone")
      .x(function(d) { return x(d.year); })
      .y(function(d) { return y(d["cumulativercp45"]); })
      .defined(function(d) { return !isNaN(d.year) });
    var linercp60 = d3.svg.line().interpolate("monotone")
      .x(function(d) { return x(d.year); })
      .y(function(d) { return y(d["cumulativercp60"]); })
      .defined(function(d) { return !isNaN(d.year) });
    var linercp85 = d3.svg.line().interpolate("monotone")
      .x(function(d) { return x(d.year); })
      .y(function(d) { return y(d["cumulativercp85"]); })
      .defined(function(d) { return !isNaN(d.year) });

    var lineTemprcp3PD = d3.svg.line().interpolate("monotone")
      .x(function(d) { return x(d["cumulativercp3PD"]); })
      .y(function(d) { return y(d["highAR5rcp3PD"] - d["lowAR5rcp3PD"]); })
      .defined(function(d) { return !isNaN(d.year) });
    var lineTemprcp45 = d3.svg.line().interpolate("monotone")
    .x(function(d) { return x(d["cumulativercp45"]); })
    .y(function(d) { return y(d["highAR5rcp45"] - d["lowAR5rcp45"]); })
      .defined(function(d) { return !isNaN(d.year) });
    var lineTemprcp60 = d3.svg.line().interpolate("monotone")
    .x(function(d) { return x(d["cumulativercp60"]); })
    .y(function(d) { return y(d["highAR5rcp60"] - d["lowAR5rcp60"]); })
      .defined(function(d) { return !isNaN(d.year) });
    var lineTemprcp85 = d3.svg.line().interpolate("monotone")
    .x(function(d) { return x(d["cumulativercp85"]); })
    .y(function(d) { return y(d["highAR5rcp85"] - d["lowAR5rcp85"]); })
      .defined(function(d) { return !isNaN(d.year) });


    // range = d3.svg.area()
    //   .interpolate("monotone")
    //   .x(function(d) { return x(d.year); })
    //   .y0(function(d) { return y(d[lowLineSelection]); })
    //   .y1(function(d) { return y(d[highLineSelection]); })
    //   .defined(function(d) { return !isNaN(d.year) });

    // // Add the area between
    //  svg.append("clipPath")
    //      .attr("id", "rangeClip")
    //    .append("path")
    //      .attr("class", "area")
    //      .attr("clip-path", "url(#clip)")
    //      .attr("d", range(data));
    // 
    //  // Add shaded background
    //  svg.append("rect")
    //      .attr("fill", "url(#shading)")
    //      .attr("id", "shade-block")
    //      .attr("y", y(12))
    //      .attr("width", width)
    //      .attr("height", y(-1) - y(12))
    //      .attr("clip-path", "url(#rangeClip)");

     // Add the lines
     svg.append("path").attr("clip-path", "url(#clip)").classed("emissions-line",true)
        .attr("id", "linercp3PD").attr("d", linercp3PD(data));
     svg.append("path").attr("clip-path", "url(#clip)").classed("emissions-line",true)
        .attr("id", "linercp45").attr("d", linercp45(data));
     svg.append("path").attr("clip-path", "url(#clip)").classed("emissions-line",true)
        .attr("id", "linercp60").attr("d", linercp60(data));
     svg.append("path").attr("clip-path", "url(#clip)").classed("emissions-line",true)
        .attr("id", "linercp85").attr("d", linercp85(data));

    // Add the observed line
    // svg.append("path")
    //   .attr("class", "lineObserved")
    //   .attr("clip-path", "url(#clip)")
    //   .attr("d", observed(data));
      
    function redraw(view) {
      var t = svg.transition().duration(1250);
      // Reset x axis on first animation to allow zoom out from now
      if (view == "emissions") {
        lowerBounds = 1860 - dataStartYear + 6;
        upperBounds = 2012 - dataStartYear + 6;
        y.domain([0, data[upperBounds].cumulativercp85 + 100]);
        x.domain([data[lowerBounds].year, data[upperBounds].year]);
        t.select(".x.axis").call(xAxis);
        t.select(".y.axis").call(yAxis);
        t.select("#linercp3PD").attr("d", linercp3PD(data)).style("opacity","1");
        t.select("#linercp45").attr("d", linercp45(data)).style("opacity","1");
        t.select("#linercp60").attr("d", linercp60(data)).style("opacity","1");
        t.select("#linercp85").attr("d", linercp85(data)).style("opacity","1");
        untouched = false;
      }      
      else if (view == "scenarios") {
        upperBounds = 2100 - dataStartYear + 6;
        lowerBounds = 2013 - dataStartYear + 6;
        x.domain([data[lowerBounds].year, data[upperBounds].year]);
        y.domain([0, data[upperBounds].cumulativercp85 + 100]);
        t.select(".x.axis").call(xAxis);
        t.select(".y.axis").call(yAxis);
        t.select("#linercp3PD").attr("d", linercp3PD(data)).style("opacity","1");
        t.select("#linercp45").attr("d", linercp45(data)).style("opacity","1");
        t.select("#linercp60").attr("d", linercp60(data)).style("opacity","1");
        t.select("#linercp85").attr("d", linercp85(data)).style("opacity","1");
        d3.select("y label").text("Cumulative carbon emissions (Mt)");
      }
      else if (view == "temps") {
        upperBounds = 1870 - dataStartYear + 6;
        lowerBounds = 2013 - dataStartYear + 6;
        y.domain([-1,5]);
        x.domain([0,1500]);
        t.select(".x.axis").call(xAxis);
        t.select(".y.axis").call(yAxis);
        t.select("#linercp3PD").attr("d", lineTemprcp3PD(data)).style("opacity","1");
        t.select("#linercp45").attr("d",  lineTemprcp45(data)).style("opacity","1");
        t.select("#linercp60").attr("d",  lineTemprcp60(data)).style("opacity","1");
        t.select("#linercp85").attr("d",  lineTemprcp85(data)).style("opacity","1");
        d3.select("y label").text("Temperature change (°C)");
        var mousemove = function() {
           var x0 = x.invert(d3.mouse(this)[0]),
               i = bisectDate(data, x0, 1),
               d0 = data[i - 1],
               d1 = data[i],
               d = x0 - d0.date > d1.date - x0 ? d1 : d0;
           focus.attr("transform", "translate(" + x(d.year) + "," + y(d.lineTemprcp3PD) + ")");
           focus.select("text").text(d.year);
         }
      }
      // Update data and redraw
      // t.select("#shade-block").attr("y", y(12)).attr("height", y(-1) - y(12))
      // t.select(".area").attr("d", range(data)).style("opacity","1");
      // t.select(".lineObserved").attr("d", observed(data)).style("opacity","1");
      // t.select("#shade-block").style("opacity","1");

      d3.select("#info").text("Temperature projections for RCP scenario" + scenarioName + ", based on Transient Climate Response of " + tcr + " and Equilibrium Climate Sensitivity range of " + ecs + ".");
    }

    // Activate chooser buttons
    d3.select(".emissions").on("click",function() { redraw("emissions"); });
    d3.select(".scenarios").on("click",function() { redraw("scenarios"); });
    d3.select(".temps").on("click",function() { redraw("temps"); });

    // Activate lock icon
    d3.select("#lock").on("click",function() { 
      if(!locked) {
        d3.select("#lock-icon").text("\uF023")
        locked = true;
      } else {
        d3.select("#lock-icon").text("\uF09C")
        locked = false;
      }
    });

   // Activate zoom buttons
    d3.select("#lock-left-minus").on("click",function() { 
      if (lowerBounds - 50 > -6) { lowerBounds -= 50; redraw(); }
    });
    d3.select("#lock-left-plus").on("click",function() { 
      if (lowerBounds + 50 < upperBounds) { lowerBounds += 50; redraw(); }
    });
    d3.select("#lock-right-minus").on("click",function() { 
      if (upperBounds + 50 > upperBounds - 2099 + 6) { upperBounds += 50; redraw(); }
    });
    d3.select("#lock-right-plus").on("click",function() {
      if (upperBounds - 50 > lowerBounds) { upperBounds -= 50; redraw(); }
    });

    // Highlight lines
    function nameLine(action) {
      if (action == "remove") svg.select("#line-label").remove();
      else svg.append("text").attr("id","line-label").text(function() {
        if (action == "linercp85") return "Highest emissions scenario (RCP 8.5)"
        else if (action == "linercp60")  return "High emissions scenario (RCP 6.0)"
        else if (action == "linercp45")  return "Low emissions scenario (RCP 4.5)"
        else if (action == "linercp3PD") return "Lowest emissions scenario (RCP 3PD)"
      }).attr("x", 5).attr("y",27).attr("text-anchor","start");
    }
    d3.selectAll(".emissions-line").on("mouseover", function(){
      d3.select(this).classed("highlighted-line",true);
      nameLine(d3.select(this).attr("id"));
    });
    d3.selectAll(".emissions-line").on("mouseout", function(){ d3.select(this).classed("highlighted-line",false); nameLine("remove"); });
  });

  // Parse and filter the data
  function parse(d) {
    d.year = parseInt(d["1"]);
    d.observations = parseFloat(d["2"]);
    d.forcing = parseFloat(d["3"]);
    d.aerosol = parseFloat(d["4"]);
    d.cumulativercp3PD = parseFloat(d["5"]);
    d.lowAR5rcp3PD = parseFloat(d["6"]);
    d.lowAR4rcp3PD = parseFloat(d["7"]);
    d.highAR5rcp3PD = parseFloat(d["8"]);
    d.highAR4rcp3PD = parseFloat(d["9"]);
    d.cumulativercp45 = parseFloat(d["14"]);
    d.lowAR5rcp45 = parseFloat(d["15"]);
    d.lowAR4rcp45 = parseFloat(d["16"]);
    d.highAR5rcp45 = parseFloat(d["17"]);
    d.highAR4rcp45 = parseFloat(d["18"]);
    d.cumulativercp60 = parseFloat(d["23"]);
    d.lowAR5rcp60 = parseFloat(d["24"]);
    d.lowAR4rcp60 = parseFloat(d["25"]);
    d.highAR5rcp60 = parseFloat(d["26"]);
    d.highAR4rcp60 = parseFloat(d["27"]);
    d.cumulativercp85 = parseFloat(d["32"]);
    d.lowAR5rcp85 = parseFloat(d["33"]);
    d.lowAR4rcp85 = parseFloat(d["34"]);
    d.highAR5rcp85 = parseFloat(d["35"]);
    d.highAR4rcp85 = parseFloat(d["36"]);
    return d;
  }
}
drawGraph();

</script>
</html>